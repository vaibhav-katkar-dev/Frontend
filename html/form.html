<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Form Viewer</title>
    <script defer data-domain="form2chat.me" src="https://plausible.io/js/plausible.js"></script>


  <link rel="stylesheet" href="/css/form.css">
  <style>
  /* Loading overlay spinner */
  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  #loading-overlay .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #007bff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Optional: scrollable form */
  .form-container {
    max-height: 80vh;
    overflow-y: auto;
    padding-right: 10px;
  }
</style>

</head>

<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <div class="form-wrapper">
    <h2 id="form-title">Untitled Form</h2>
    <div class="form-container">
      <form id="dynamic-form">
        <!-- your form groups go here -->
        <div class="form-group">

        </div>
        <!-- more fields -->
        <button type="submit" id="submit-button">Submit</button>
      </form>
    </div>
  </div>


  <script>
    const baseURL = "https://api.form2chat.me/";
    // window.location.hostname === "localhost"
    //   ? "http://localhost:5000"
    //   : "https://formhit.onrender.com";

    let number;
    let canUseWhatsApp = false;
let remainingFreeMessages = 0;
let showLimitWarning = false;

    document.addEventListener("DOMContentLoaded", () => {
      const overlay = document.getElementById("loading-overlay");
overlay.style.display = "flex"; // show overlay while loading

      const urlParams = new URLSearchParams(window.location.search);
      const formId = urlParams.get("formId"); // âœ… Use 'formId', not 'id'

      if (!formId) {
        console.error("formId is missing from URL");
        return;
      }

      const apiURL = `${baseURL}/api/forms/by-id/${formId}`;

      fetch(apiURL)
        .then((res) => {

          if (!res.ok) throw new Error("Form not found");
        

          return res.json();

        })
        .then((data) => {
                    overlay.style.display = "none"; // hide overlay on error

          document.getElementById("form-title").innerText = data.title;
          number = data.description;
          countryCode = data.countryCode || "0";
            canUseWhatsApp = data.canUseWhatsApp;
remainingFreeMessages = data.remainingFreeMessages;
showLimitWarning = data.showLimitWarning;

          const form = document.getElementById("dynamic-form");
          form.innerHTML = ""; // Clear any existing content


          data.fields.forEach((field) => {
            if (!field || !field.type || !field.label) return;

            const div = document.createElement("div");
            div.className = "form-group";

            const label = document.createElement("label");
            label.innerHTML = field.label + (field.required ? ' <span style="color:red">*</span>' : '');
            div.appendChild(label);


            // âœ… Radio field
            if (field.type === "radio" && Array.isArray(field.options) && field.options.length > 0) {
              field.options.forEach((option, index) => {
                const radioWrapper = document.createElement("div");
                radioWrapper.className = "radio-option";

                const radioInput = document.createElement("input");
                radioInput.type = "radio";
                radioInput.name = field.label;
                radioInput.value = option;
                radioInput.id = `${field.label}-${index}`;
                if (field.required && index === 0) radioInput.required = true;

                const radioLabel = document.createElement("label");
                radioLabel.htmlFor = radioInput.id;
                radioLabel.innerText = option;

                radioWrapper.appendChild(radioInput);
                radioWrapper.appendChild(radioLabel);
                div.appendChild(radioWrapper);
              });

              // âœ… Checkbox field (single or multiple)
            } else if (field.type === "checkbox") {
              const checkboxWrapper = document.createElement("div");
              checkboxWrapper.className = "checkbox-option";

              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = field.label;
              checkbox.required = field.required;
              checkbox.id = `${field.label}-checkbox`;

              const checkboxLabel = document.createElement("label");
              checkboxLabel.htmlFor = checkbox.id;
              checkboxLabel.innerText = field.placeholder || "I agree";

              checkboxWrapper.appendChild(checkbox);
              checkboxWrapper.appendChild(checkboxLabel);
              div.appendChild(checkboxWrapper);

              // âœ… Select dropdown field
            } else if (field.type === "select" && Array.isArray(field.options) && field.options.length > 0) {
              const select = document.createElement("select");
              select.name = field.label;
              select.required = field.required;

              const defaultOption = document.createElement("option");
              defaultOption.disabled = true;
              defaultOption.selected = true;
              defaultOption.innerText = field.placeholder || "Select an option";
              select.appendChild(defaultOption);

              field.options.forEach((option) => {
                const opt = document.createElement("option");
                opt.value = option;
                opt.innerText = option;
                select.appendChild(opt);
              });

              div.appendChild(select);

              // âœ… Textarea field
            } else if (field.type === "textarea") {
              const input = document.createElement("textarea");
              input.placeholder = field.placeholder || "";
              input.required = field.required;
              const labelLower = field.label.toLowerCase();
              const isPhone = labelLower.includes("whatsapp") || labelLower.includes("phone") || labelLower.includes("mobile");
              input.name = isPhone ? "description" : field.label;
              div.appendChild(input);

              // âœ… All other inputs (text, date, etc.)
            } else {
              const input = document.createElement("input");
              input.type = field.type;
              input.placeholder = field.placeholder || "";
              input.required = field.required;
              const labelLower = field.label.toLowerCase();
              const isPhone = labelLower.includes("whatsapp") || labelLower.includes("phone") || labelLower.includes("mobile");
              input.name = isPhone ? "description" : field.label;
              div.appendChild(input);
            }

            form.appendChild(div);

          });

          const submitBtn = document.createElement("button");
          submitBtn.type = "submit";
          submitBtn.innerText = "Submit";
          submitBtn.id = "submit-button";
          form.appendChild(submitBtn);

          

          // âœ… Add only ONE submit listener
          form.addEventListener("submit", function (e) {
            e.preventDefault();
           submitBtn.disabled = true;
            submitBtn.textContent = "â³ Submitting...";


            const inputs = form.querySelectorAll("input, textarea, select");
            const responseData = {};

            inputs.forEach((input) => {
              const name = input.name;
              if (!name) return;

              // âœ… Handle checkboxes (multiple values)
              if (input.type === "checkbox") {
                if (!responseData[name]) responseData[name] = [];
                if (input.checked) responseData[name].push(input.value || true);
              }

              // âœ… Handle radio buttons (only one checked)
              else if (input.type === "radio") {
                if (input.checked) {
                  responseData[name] = input.value;
                }
              }

              // âœ… Handle text, textarea, select, etc.
              else {
                responseData[name] = input.value;
              }
            });

            // âœ… Submit the collected data
            fetch(`${baseURL}/api/forms/${formId}/responses`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(responseData),
            })
              .then((res) => {
                if (!res.ok) throw new Error("Server error");
                return res.json();
              })
              .then((result) => {

                // console.log("âœ… Form submitted successfully!");
                showFullScreenSuccess("âœ… Form successfully submitted!");


                if (number && canUseWhatsApp) {
  setTimeout(() => {
    sendToWhatsApp(number, responseData, countryCode);
  }, 400);
}

               submitBtn.disabled = true;
submitBtn.textContent = "â³ Submitting...";

                form.reset();

                // Log full submitted response data
                console.log("ðŸ“¦ Submitted Data:", responseData);
                // Notify parent and request closing
                window.parent.postMessage({ type: "formSubmitted" }, "*"); 


                
              })

              .catch((err) => {
                console.error("Submission error:", err);
                alert("Failed to submit.");
                submitBtn.disabled = false;
              });



          });

        })
        .catch((err) => {
          overlay.style.display = "none"; // hide overlay on error

          console.error("Error loading form:", err);
          document.getElementById("form-title").innerText = "Failed to load form.";
        });
    });


    function showFullScreenSuccess(message) {
      // Create overlay
      const overlay = document.createElement("div");
      overlay.className = "success-overlay";

      // Create message box
      const box = document.createElement("div");
      box.className = "success-box";
      box.textContent = message;

      overlay.appendChild(box);
      document.body.appendChild(overlay);

      // Show animation
      setTimeout(() => overlay.classList.add("show"), 10);

   
    }





    // ðŸ“² Function to send form data to WhatsApp
    function sendToWhatsApp(phoneNumber, formData, countryCode ) {
      if (!phoneNumber) {
        console.warn("âŒ No phone number provided in form data");
        return;
      }

      // Clean number
      const formatted = String(phoneNumber).replace(/\D/g, "");
      console.log("ðŸ“ž Cleaned Phone Number:", formatted);

      // Build message
     let customMessage = Object.entries(formData)
  .map(([key, value]) => `${key}: ${value}`)
  .join("\n");

// ðŸ”” Add upgrade tip if free messages are low
if (showLimitWarning && remainingFreeMessages <= 10) {
  customMessage += `

âš ï¸ Only ${remainingFreeMessages} free WhatsApp messages remaining.
ðŸš€ Upgrade for unlimited WhatsApp:
ðŸ‘‰ https://www.form2chat.me/html/billing.html
`;
}


      const encodedMessage = encodeURIComponent(customMessage);

      // Create URL
      const whatsappURL = `https://wa.me/${countryCode}${formatted}?text=${encodedMessage}`;
      console.log("ðŸ“¤ WhatsApp URL:", whatsappURL);

      // Open in new tab
      window.open(whatsappURL, "_blank");
    }

  </script>

  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>

</body>

</html>