<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script defer data-domain="form2chat.me" src="https://plausible.io/js/plausible.js"></script>
  <title>Form Responses</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF and autotable for PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Base styles (unchanged) */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      color: #2c3e50;
    }

    /* Existing Loading Bar (unchanged) */
    #loading-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 0%;
      height: 4px;
      background: linear-gradient(90deg, #6a11cb, #2575fc);
      z-index: 1000;
      transition: width 0.3s ease;
      display: none;
    }
    #loading-bar.show {
      display: block;
      animation: loading 1.5s ease-in-out infinite;
    }
    @keyframes loading {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* NEW: Loading Spinner */
    #loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3; /* Light gray border */
      border-top: 4px solid #6a11cb; /* Purple top border for rotation effect */
      border-radius: 50%;
      z-index: 1001; /* Above loading bar */
      display: none;
      animation: spin 1s linear infinite;
      aria-hidden: true; /* Hide from screen readers as it's decorative */
    }
    #loading-spinner.show {
      display: block;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Rest of your existing styles (navbar, buttons, table, etc.) remain unchanged */
    /* ... (include all original CSS here for completeness) ... */

    /* Upgrade Notification Bar (unchanged) */
    #upgrade-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: linear-gradient(135deg, #007bff, #28a745, #17a2b8);
      color: #fff;
      padding: 18px 20px;
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
      border-top: 3px solid #fff;
      z-index: 999;
      display: none;
      animation: slideUp 0.6s ease-out;
      border-radius: 8px 8px 0 0;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    #upgrade-bar.show {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #upgrade-bar .message {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    #upgrade-bar .upgrade-btn {
      background: #fff;
      color: #007bff;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
    }
    #upgrade-bar .upgrade-btn:hover {
      background: #e9ecef;
      color: #0056b3;
    }
    #upgrade-bar .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, transform 0.2s;
      margin-left: 10px;
      margin-right: 3%;
    }
    #upgrade-bar .close-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: scale(1.1);
    }
    @media (max-width: 768px) {
      #upgrade-bar {
        padding: 15px 15px;
        font-size: 14px;
      }
      #upgrade-bar .upgrade-btn {
        padding: 6px 12px;
        font-size: 12px;
      }
      #upgrade-bar .close-btn {
        font-size: 16px;
        width: 26px;
        height: 26px;
      }
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 1rem;
      background: linear-gradient(90deg, #6a11cb, #2575fc);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .navbar h2 {
      font-size: 16px;
      margin: 0;
      font-weight: 600;
    }
    .back-button {
      background-color: #ffffff;
      color: #2575fc;
      padding: 5px 10px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .back-button:hover {
      background-color: #e3e9ff;
    }
    h1 {
      font-size: 20px;
      margin: 1rem 0 0.5rem;
      text-align: center;
      color: #343a40;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 0.5rem auto;
      padding: 0.5rem;
    }
    .action-buttons button {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 6px;
      border: none;
      background: linear-gradient(to right, #43cea2, #185a9d);
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.25s ease-in-out;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .action-buttons button:hover {
      transform: translateY(-2px);
      opacity: 0.9;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    }
    .action-buttons button:active {
      transform: scale(0.97);
    }
    table {
      width: 95%;
      margin: 1rem auto;
      border-collapse: collapse;
      background: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      font-size: 13px;
      border: 1px solid #e1e5ea;
      word-break: break-word;
    }
    th {
      background-color: #e9ecef;
      font-weight: bold;
      color: #333;
    }
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    tr:hover {
      background-color: #eef2f7;
      transition: background-color 0.2s ease;
    }
    @media (max-width: 768px) {
      * {
        box-sizing: border-box;
      }
      body {
        padding: 1rem;
        margin: 0;
        background-color: #f6f9fc;
      }
      .action-buttons {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      .action-buttons button {
        width: 100%;
        max-width: 320px;
        font-size: 13px;
        padding: 10px 14px;
        border-radius: 8px;
        background-color: #357edd;
        color: white;
        border: none;
        transition: background 0.2s;
      }
      .action-buttons button:hover {
        background-color: #285ec4;
      }
      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
        width: 100%;
      }
      thead {
        display: none;
      }
      tr {
        margin-bottom: 14px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        padding: 14px;
        border-left: 4px solid #357edd;
      }
      td {
        border: none;
        position: relative;
        padding: 10px 10px;
        text-align: left;
        font-size: 14px;
        line-height: 1.5;
        border-bottom: 1px solid #f0f0f0;
        background-color: white;
        color: #333;
        word-break: break-word;
      }
      td::before {
        content: attr(data-label);
        display: block;
        font-weight: bold;
        color: #357edd;
        font-size: 13px;
        margin-bottom: 4px;
      }
      td:last-child {
        border-bottom: none;
      }
    }
    .action-buttons i {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <!-- Existing Loading Bar -->
  <div id="loading-bar"></div>

  <!-- NEW: Loading Spinner -->
  <div id="loading-spinner"></div>

  <!-- Rest of your body remains unchanged -->
  <div class="navbar">
    <button class="back-button" onclick="window.history.back()">‚Üê Back</button>
    <h2>Responses</h2>
    <div></div>
  </div>
  <div class="action-buttons">
    <button onclick="downloadCSV()">
      <i class="fas fa-file-csv"></i> Download CSV
    </button>
    <button onclick="downloadExcel()">
      <i class="fas fa-file-excel"></i> Download Excel
    </button>
    <button onclick="downloadPDF()">
      <i class="fas fa-file-pdf"></i> Download PDF
    </button>
  </div>
  <h1>Form Responses</h1>
  <table id="response-table">
    <thead>
      <tr id="table-headers"></tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
  <div id="upgrade-bar">
    <div class="message">Unlock unlimited responses and premium features! Upgrade now üöÄ</div>
    <button class="upgrade-btn" onclick="upgradeNow()">Upgrade</button>
    <button class="close-btn" onclick="hideUpgradeBar()">√ó</button>
  </div>

  <script src="/js/authCheak.js"></script>  <!-- Note: Typo in filename; consider renaming to 'authCheck.js' -->

  <script>
    const baseURL = "https://api.form2chat.me";
    // window.location.hostname === "localhost"
    //   ? "http://localhost:5000"
    //   : "https://formhit.onrender.com";

    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const formId = urlParams.get("formId");
      let storedEmail = localStorage.getItem("email");
      console.log("Stored Email:", storedEmail);

      if (!formId) {
        document.body.innerHTML = "<h2>‚ùå No formId provided in URL</h2>";
        throw new Error("formId is required in URL");
      }
      const userId = localStorage.getItem("userId");  // Fixed: Declared with const

      // Show loading bar AND spinner only during fetch
      const loadingBar = document.getElementById("loading-bar");
      const loadingSpinner = document.getElementById("loading-spinner");
      loadingBar.classList.add("show");
      loadingSpinner.classList.add("show");

      fetch(`${baseURL}/api/forms/responses/by-id/${formId}/${userId}`, {  // Fixed: Removed extra space
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`,
        },
      })
        .then(res => {
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          return res.json();
        })
        .then(data => {
          const responses = data.responses;

          // Check for upgradeRequired
          if (data.upgradeRequired) {
            showUpgradeBar();
          }

          if (!responses || responses.length === 0) {
            document.getElementById("table-body").innerHTML =
              "<tr><td colspan='100%'>No responses found</td></tr>";
            return;
          }

          const allHeadersSet = new Set();
          responses.forEach(response => {
            Object.keys(response.answers || {}).forEach(key => {
              allHeadersSet.add(key);
            });
          });
          const headers = Array.from(allHeadersSet);

          const headerRow = document.getElementById("table-headers");
          const srTh = document.createElement("th");
          srTh.textContent = "SR No.";
          headerRow.appendChild(srTh);

          headers.forEach(header => {
            const th = document.createElement("th");
            th.textContent = header;
            headerRow.appendChild(th);
          });

          const tableBody = document.getElementById("table-body");

          responses.forEach((response, index) => {
            const tr = document.createElement("tr");

            const srTd = document.createElement("td");
            srTd.textContent = index + 1;
            srTd.setAttribute("data-label", "SR No.");
            tr.appendChild(srTd);

            headers.forEach(header => {
              const td = document.createElement("td");
              td.textContent = response.answers[header] || "";
              td.setAttribute("data-label", header);
              tr.appendChild(td);
            });

            tableBody.appendChild(tr);
          });
        })
        .catch(err => {
          console.error("Error fetching responses:", err);
          document.body.innerHTML = `<h2>‚ö†Ô∏è Error loading responses: ${err.message}</h2>`;
        })
        .finally(() => {
          // Hide loading bar AND spinner
          loadingBar.classList.remove("show");
          loadingSpinner.classList.remove("show");
        });

      // ... (rest of your functions like downloadCSV, etc., remain unchanged)
    });

    function downloadCSV() {
      const table = document.getElementById("response-table");
      let csv = [];
      for (let row of table.rows) {
        let rowData = [];
        for (let cell of row.cells) {
          rowData.push('"' + cell.innerText.replace(/"/g, '""') + '"');
        }
        csv.push(rowData.join(","));
      }
      const blob = new Blob([csv.join("\n")], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "responses.csv";
      link.click();
    }

   function downloadExcel() {
      const table = document.getElementById("response-table");
      const wb = XLSX.utils.table_to_book(table, { sheet: "Responses" });
      XLSX.writeFile(wb, "responses.xlsx");
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("l", "mm", "a4"); // landscape mode for wide table
      doc.setFontSize(10); // smaller font
      doc.text("Form Responses", 14, 10);

      doc.autoTable({
        html: "#response-table",
        startY: 15,
        styles: {
          fontSize: 8,         // shrink font inside table
          cellPadding: 2,      // reduce cell padding
        },
        headStyles: {
          fillColor: [53, 126, 221], // match your theme
          textColor: 255,
        },
        margin: { left: 10, right: 10 },
        tableWidth: 'auto',   // shrink to fit
        theme: 'striped',
      });

      doc.save("responses.pdf");
    }

    function showUpgradeBar() {
      const upgradeBar = document.getElementById("upgrade-bar");
      upgradeBar.classList.add("show");
    }

    function hideUpgradeBar() {
      const upgradeBar = document.getElementById("upgrade-bar");
      upgradeBar.classList.remove("show");
    }

    function upgradeNow() {
      // Redirect to billing page or handle upgrade logic
      window.location.href = "billing.html";
    }
  </script>
</body>
</html>
